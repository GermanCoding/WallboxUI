# Build the vue.js frontend
FROM node:alpine
COPY . /opt/build
WORKDIR /opt/build
RUN npm install && npm run build

# Collect static files from django (needed for the autogenerated admin interface)
FROM python:slim-bookworm
ENV PYTHONUNBUFFERED=1
# Keep in sync with backend/requirements.txt
RUN pip install Django==5.1.2

# Create a python module to tell django to use the staticfiles app
RUN mkdir /django-static && mkdir sdjango && cd sdjango && \
    touch __init__.py && cd .. && \
    printf '\n\
INSTALLED_APPS = [\n\
    "django.contrib.admin",\n\
    "django.contrib.auth",\n\
    "django.contrib.contenttypes",\n\
    "django.contrib.sessions",\n\
    "django.contrib.messages",\n\
    "django.contrib.staticfiles",\n\
]\n\
\n\
# Keep in sync with backend/backend/settings.py \n\
STATIC_URL = "static/"\n\
STATIC_ROOT = "/django-static"'\
> sdjango/settings.py
RUN DJANGO_SETTINGS_MODULE=sdjango.settings python -m django collectstatic --noinput

# Finally, serve all of the above via a web server
FROM joseluisq/static-web-server:2-alpine
COPY --from=0 /opt/build/dist ./public
COPY --from=1 /django-static ./public/static/
CMD ["--page-fallback", "./public/index.html"]
